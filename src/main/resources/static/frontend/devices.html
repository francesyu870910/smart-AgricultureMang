<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备控制 - 温室数字化监控系统</title>
    <link rel="stylesheet" href="css/components.css">
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .nav {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .nav a:hover, .nav a.active {
            background: rgba(255,255,255,0.2);
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .device-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .device-card:hover {
            transform: translateY(-2px);
        }
        
        .device-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .device-icon {
            font-size: 32px;
            margin-right: 15px;
        }
        
        .device-info h3 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .device-type {
            color: #666;
            font-size: 14px;
        }
        
        .device-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-error { background: #ffc107; }
        
        .device-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .power-control {
            margin-top: 15px;
        }
        
        .power-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .power-value {
            text-align: center;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .control-panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>设备控制</h1>
            <nav class="nav">
                <a href="/dashboard.html">返回首页</a>
                <a href="environment.html">环境监控</a>
                <a href="devices.html" class="active">设备控制</a>
                <a href="alerts.html">报警管理</a>
                <a href="scheduled-tasks.html">定时任务</a>
            </nav>
        </header>

        <!-- 控制面板 -->
        <div class="control-panel">
            <h2 style="margin-bottom: 20px;">批量控制</h2>
            <div class="control-buttons">
                <button class="btn btn-success" onclick="startAllDevices()">启动所有设备</button>
                <button class="btn btn-danger" onclick="stopAllDevices()">停止所有设备</button>
                <button class="btn btn-primary" onclick="refreshDevices()">刷新状态</button>
                <button class="btn btn-warning" onclick="resetAllDevices()">重置所有设备</button>
                <button class="btn btn-secondary" onclick="exportDeviceStatus()">导出状态</button>
            </div>
        </div>

        <!-- 设备列表 -->
        <div class="devices-grid" id="devicesGrid">
            <!-- 设备卡片将通过JavaScript动态生成 -->
        </div>
    </div>

    <script>
        // API基础URL
        const API_BASE = 'http://localhost:8083/api';
        
        // 模拟设备数据
        const mockDevices = [
            { id: 'HEATER_001', name: '主加热器', type: 'heater', icon: '🔥', status: 'online', running: false, power: 0 },
            { id: 'HEATER_002', name: '辅助加热器', type: 'heater', icon: '🔥', status: 'online', running: false, power: 0 },
            { id: 'COOLER_001', name: '主冷却器', type: 'cooler', icon: '❄️', status: 'online', running: false, power: 0 },
            { id: 'HUMIDIFIER_001', name: '加湿器', type: 'humidifier', icon: '💨', status: 'online', running: false, power: 0 },
            { id: 'DEHUMIDIFIER_001', name: '除湿器', type: 'dehumidifier', icon: '🌪️', status: 'online', running: false, power: 0 },
            { id: 'FAN_001', name: '排风扇1', type: 'fan', icon: '🌀', status: 'online', running: true, power: 60 },
            { id: 'FAN_002', name: '排风扇2', type: 'fan', icon: '🌀', status: 'online', running: false, power: 0 },
            { id: 'FAN_003', name: '循环风扇', type: 'fan', icon: '🌀', status: 'error', running: false, power: 0 },
            { id: 'LIGHT_001', name: 'LED补光灯1', type: 'light', icon: '💡', status: 'online', running: true, power: 80 },
            { id: 'LIGHT_002', name: 'LED补光灯2', type: 'light', icon: '💡', status: 'online', running: true, power: 75 },
            { id: 'IRRIGATION_001', name: '滴灌系统', type: 'irrigation', icon: '💧', status: 'online', running: false, power: 0 },
            { id: 'IRRIGATION_002', name: '喷淋系统', type: 'irrigation', icon: '🚿', status: 'online', running: false, power: 0 }
        ];
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            renderDevices();
            // 每30秒自动刷新设备状态
            setInterval(refreshDevices, 30000);
        });

        // 渲染设备列表
        function renderDevices() {
            const grid = document.getElementById('devicesGrid');
            grid.innerHTML = '';
            
            mockDevices.forEach(device => {
                const deviceCard = createDeviceCard(device);
                grid.appendChild(deviceCard);
            });
        }

        // 创建设备卡片
        function createDeviceCard(device) {
            const card = document.createElement('div');
            card.className = 'device-card';
            card.innerHTML = `
                <div class="device-header">
                    <div class="device-icon">${device.icon}</div>
                    <div class="device-info">
                        <h3>${device.name}</h3>
                        <div class="device-type">${getDeviceTypeName(device.type)}</div>
                    </div>
                </div>
                
                <div class="device-status">
                    <div class="status-indicator status-${device.status}"></div>
                    <span>${getStatusText(device.status)}</span>
                    ${device.running ? '<span style="margin-left: 10px; color: #28a745;">运行中</span>' : '<span style="margin-left: 10px; color: #6c757d;">已停止</span>'}
                </div>
                
                <div class="device-controls">
                    <button class="btn btn-success" onclick="startDevice('${device.id}')" ${device.status !== 'online' || device.running ? 'disabled' : ''}>
                        启动
                    </button>
                    <button class="btn btn-danger" onclick="stopDevice('${device.id}')" ${device.status !== 'online' || !device.running ? 'disabled' : ''}>
                        停止
                    </button>
                    <button class="btn btn-warning" onclick="resetDevice('${device.id}')" ${device.status !== 'online' ? 'disabled' : ''}>
                        重置
                    </button>
                </div>
                
                <div class="power-control">
                    <label>功率控制:</label>
                    <input type="range" class="power-slider" min="0" max="100" value="${device.power}" 
                           onchange="adjustPower('${device.id}', this.value)" ${device.status !== 'online' ? 'disabled' : ''}>
                    <div class="power-value">${device.power}%</div>
                </div>
            `;
            
            return card;
        }

        // 获取设备类型中文名称
        function getDeviceTypeName(type) {
            const typeNames = {
                'heater': '加热器',
                'cooler': '冷却器',
                'humidifier': '加湿器',
                'dehumidifier': '除湿器',
                'fan': '风扇',
                'light': '补光灯',
                'irrigation': '灌溉系统'
            };
            return typeNames[type] || type;
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusTexts = {
                'online': '在线',
                'offline': '离线',
                'error': '故障'
            };
            return statusTexts[status] || status;
        }

        // 启动设备
        async function startDevice(deviceId) {
            try {
                showLoading(`正在启动设备 ${deviceId}...`);
                
                // 模拟API调用
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 更新设备状态
                const device = mockDevices.find(d => d.id === deviceId);
                if (device && device.status === 'online') {
                    device.running = true;
                    device.power = 50; // 默认功率
                    renderDevices();
                    showSuccess(`设备 ${device.name} 启动成功`);
                }
                
            } catch (error) {
                console.error('启动设备失败:', error);
                showError('启动设备失败，请重试');
            }
        }

        // 停止设备
        async function stopDevice(deviceId) {
            try {
                showLoading(`正在停止设备 ${deviceId}...`);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const device = mockDevices.find(d => d.id === deviceId);
                if (device) {
                    device.running = false;
                    device.power = 0;
                    renderDevices();
                    showSuccess(`设备 ${device.name} 已停止`);
                }
                
            } catch (error) {
                console.error('停止设备失败:', error);
                showError('停止设备失败，请重试');
            }
        }

        // 重置设备
        async function resetDevice(deviceId) {
            try {
                showLoading(`正在重置设备 ${deviceId}...`);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const device = mockDevices.find(d => d.id === deviceId);
                if (device) {
                    device.running = false;
                    device.power = 0;
                    device.status = 'online';
                    renderDevices();
                    showSuccess(`设备 ${device.name} 重置成功`);
                }
                
            } catch (error) {
                console.error('重置设备失败:', error);
                showError('重置设备失败，请重试');
            }
        }

        // 调节功率
        async function adjustPower(deviceId, power) {
            try {
                const device = mockDevices.find(d => d.id === deviceId);
                if (device) {
                    device.power = parseInt(power);
                    // 更新显示
                    const powerValue = document.querySelector(`input[onchange*="${deviceId}"]`).parentNode.querySelector('.power-value');
                    powerValue.textContent = power + '%';
                    
                    showSuccess(`设备 ${device.name} 功率调节为 ${power}%`);
                }
                
            } catch (error) {
                console.error('调节功率失败:', error);
                showError('调节功率失败，请重试');
            }
        }

        // 启动所有设备
        async function startAllDevices() {
            if (!confirm('确定要启动所有在线设备吗？')) return;
            
            try {
                showLoading('正在启动所有设备...');
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                mockDevices.forEach(device => {
                    if (device.status === 'online') {
                        device.running = true;
                        device.power = 50;
                    }
                });
                
                renderDevices();
                showSuccess('所有在线设备已启动');
                
            } catch (error) {
                console.error('批量启动失败:', error);
                showError('批量启动失败，请重试');
            }
        }

        // 停止所有设备
        async function stopAllDevices() {
            if (!confirm('确定要停止所有设备吗？')) return;
            
            try {
                showLoading('正在停止所有设备...');
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                mockDevices.forEach(device => {
                    device.running = false;
                    device.power = 0;
                });
                
                renderDevices();
                showSuccess('所有设备已停止');
                
            } catch (error) {
                console.error('批量停止失败:', error);
                showError('批量停止失败，请重试');
            }
        }

        // 刷新设备状态
        async function refreshDevices() {
            try {
                showLoading('正在刷新设备状态...');
                
                // 模拟随机状态变化
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                mockDevices.forEach(device => {
                    // 随机模拟一些状态变化
                    if (Math.random() < 0.1) {
                        device.power = Math.floor(Math.random() * 100);
                    }
                });
                
                renderDevices();
                showSuccess('设备状态已刷新');
                
            } catch (error) {
                console.error('刷新失败:', error);
                showError('刷新失败，请重试');
            }
        }

        // 重置所有设备
        async function resetAllDevices() {
            if (!confirm('确定要重置所有设备吗？这将停止所有设备并清除故障状态。')) return;
            
            try {
                showLoading('正在重置所有设备...');
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                mockDevices.forEach(device => {
                    device.running = false;
                    device.power = 0;
                    device.status = 'online';
                });
                
                renderDevices();
                showSuccess('所有设备已重置');
                
            } catch (error) {
                console.error('批量重置失败:', error);
                showError('批量重置失败，请重试');
            }
        }

        // 导出设备状态
        function exportDeviceStatus() {
            const data = mockDevices.map(device => ({
                设备ID: device.id,
                设备名称: device.name,
                设备类型: getDeviceTypeName(device.type),
                状态: getStatusText(device.status),
                运行状态: device.running ? '运行中' : '已停止',
                功率: device.power + '%'
            }));
            
            const csv = convertToCSV(data);
            downloadCSV(csv, 'device_status.csv');
            showSuccess('设备状态已导出');
        }

        // 转换为CSV格式
        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header]).join(','))
            ].join('\n');
            return csvContent;
        }

        // 下载CSV文件
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 显示加载消息
        function showLoading(message) {
            showMessage(message, '#17a2b8', '#d1ecf1');
        }

        // 显示成功消息
        function showSuccess(message) {
            showMessage(message, '#155724', '#d4edda');
        }

        // 显示错误消息
        function showError(message) {
            showMessage(message, '#721c24', '#f8d7da');
        }

        // 显示消息
        function showMessage(message, color, background) {
            const div = document.createElement('div');
            div.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${background};
                color: ${color};
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                z-index: 1000;
                max-width: 300px;
            `;
            div.textContent = message;
            document.body.appendChild(div);
            
            setTimeout(() => {
                if (document.body.contains(div)) {
                    document.body.removeChild(div);
                }
            }, 3000);
        }
    </script>
</body>
</html>
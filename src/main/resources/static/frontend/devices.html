<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡æ§åˆ¶ - æ¸©å®¤æ•°å­—åŒ–ç›‘æ§ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/components.css">
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .nav {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .nav a:hover, .nav a.active {
            background: rgba(255,255,255,0.2);
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .device-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .device-card:hover {
            transform: translateY(-2px);
        }
        
        .device-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .device-icon {
            font-size: 32px;
            margin-right: 15px;
        }
        
        .device-info h3 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .device-type {
            color: #666;
            font-size: 14px;
        }
        
        .device-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-error { background: #ffc107; }
        
        .device-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .power-control {
            margin-top: 15px;
        }
        
        .power-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .power-value {
            text-align: center;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .control-panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>è®¾å¤‡æ§åˆ¶</h1>
            <nav class="nav">
                <a href="/dashboard.html">è¿”å›é¦–é¡µ</a>
                <a href="environment.html">ç¯å¢ƒç›‘æ§</a>
                <a href="devices.html" class="active">è®¾å¤‡æ§åˆ¶</a>
                <a href="alerts.html">æŠ¥è­¦ç®¡ç†</a>
                <a href="scheduled-tasks.html">å®šæ—¶ä»»åŠ¡</a>
            </nav>
        </header>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <h2 style="margin-bottom: 20px;">æ‰¹é‡æ§åˆ¶</h2>
            <div class="control-buttons">
                <button class="btn btn-success" onclick="startAllDevices()">å¯åŠ¨æ‰€æœ‰è®¾å¤‡</button>
                <button class="btn btn-danger" onclick="stopAllDevices()">åœæ­¢æ‰€æœ‰è®¾å¤‡</button>
                <button class="btn btn-primary" onclick="refreshDevices()">åˆ·æ–°çŠ¶æ€</button>
                <button class="btn btn-warning" onclick="resetAllDevices()">é‡ç½®æ‰€æœ‰è®¾å¤‡</button>
                <button class="btn btn-secondary" onclick="exportDeviceStatus()">å¯¼å‡ºçŠ¶æ€</button>
            </div>
        </div>

        <!-- è®¾å¤‡åˆ—è¡¨ -->
        <div class="devices-grid" id="devicesGrid">
            <!-- è®¾å¤‡å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // APIåŸºç¡€URL
        const API_BASE = 'http://localhost:8083/api';
        
        // æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®
        const mockDevices = [
            { id: 'HEATER_001', name: 'ä¸»åŠ çƒ­å™¨', type: 'heater', icon: 'ğŸ”¥', status: 'online', running: false, power: 0 },
            { id: 'HEATER_002', name: 'è¾…åŠ©åŠ çƒ­å™¨', type: 'heater', icon: 'ğŸ”¥', status: 'online', running: false, power: 0 },
            { id: 'COOLER_001', name: 'ä¸»å†·å´å™¨', type: 'cooler', icon: 'â„ï¸', status: 'online', running: false, power: 0 },
            { id: 'HUMIDIFIER_001', name: 'åŠ æ¹¿å™¨', type: 'humidifier', icon: 'ğŸ’¨', status: 'online', running: false, power: 0 },
            { id: 'DEHUMIDIFIER_001', name: 'é™¤æ¹¿å™¨', type: 'dehumidifier', icon: 'ğŸŒªï¸', status: 'online', running: false, power: 0 },
            { id: 'FAN_001', name: 'æ’é£æ‰‡1', type: 'fan', icon: 'ğŸŒ€', status: 'online', running: true, power: 60 },
            { id: 'FAN_002', name: 'æ’é£æ‰‡2', type: 'fan', icon: 'ğŸŒ€', status: 'online', running: false, power: 0 },
            { id: 'FAN_003', name: 'å¾ªç¯é£æ‰‡', type: 'fan', icon: 'ğŸŒ€', status: 'error', running: false, power: 0 },
            { id: 'LIGHT_001', name: 'LEDè¡¥å…‰ç¯1', type: 'light', icon: 'ğŸ’¡', status: 'online', running: true, power: 80 },
            { id: 'LIGHT_002', name: 'LEDè¡¥å…‰ç¯2', type: 'light', icon: 'ğŸ’¡', status: 'online', running: true, power: 75 },
            { id: 'IRRIGATION_001', name: 'æ»´çŒç³»ç»Ÿ', type: 'irrigation', icon: 'ğŸ’§', status: 'online', running: false, power: 0 },
            { id: 'IRRIGATION_002', name: 'å–·æ·‹ç³»ç»Ÿ', type: 'irrigation', icon: 'ğŸš¿', status: 'online', running: false, power: 0 }
        ];
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            renderDevices();
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°è®¾å¤‡çŠ¶æ€
            setInterval(refreshDevices, 30000);
        });

        // æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
        function renderDevices() {
            const grid = document.getElementById('devicesGrid');
            grid.innerHTML = '';
            
            mockDevices.forEach(device => {
                const deviceCard = createDeviceCard(device);
                grid.appendChild(deviceCard);
            });
        }

        // åˆ›å»ºè®¾å¤‡å¡ç‰‡
        function createDeviceCard(device) {
            const card = document.createElement('div');
            card.className = 'device-card';
            card.innerHTML = `
                <div class="device-header">
                    <div class="device-icon">${device.icon}</div>
                    <div class="device-info">
                        <h3>${device.name}</h3>
                        <div class="device-type">${getDeviceTypeName(device.type)}</div>
                    </div>
                </div>
                
                <div class="device-status">
                    <div class="status-indicator status-${device.status}"></div>
                    <span>${getStatusText(device.status)}</span>
                    ${device.running ? '<span style="margin-left: 10px; color: #28a745;">è¿è¡Œä¸­</span>' : '<span style="margin-left: 10px; color: #6c757d;">å·²åœæ­¢</span>'}
                </div>
                
                <div class="device-controls">
                    <button class="btn btn-success" onclick="startDevice('${device.id}')" ${device.status !== 'online' || device.running ? 'disabled' : ''}>
                        å¯åŠ¨
                    </button>
                    <button class="btn btn-danger" onclick="stopDevice('${device.id}')" ${device.status !== 'online' || !device.running ? 'disabled' : ''}>
                        åœæ­¢
                    </button>
                    <button class="btn btn-warning" onclick="resetDevice('${device.id}')" ${device.status !== 'online' ? 'disabled' : ''}>
                        é‡ç½®
                    </button>
                </div>
                
                <div class="power-control">
                    <label>åŠŸç‡æ§åˆ¶:</label>
                    <input type="range" class="power-slider" min="0" max="100" value="${device.power}" 
                           onchange="adjustPower('${device.id}', this.value)" ${device.status !== 'online' ? 'disabled' : ''}>
                    <div class="power-value">${device.power}%</div>
                </div>
            `;
            
            return card;
        }

        // è·å–è®¾å¤‡ç±»å‹ä¸­æ–‡åç§°
        function getDeviceTypeName(type) {
            const typeNames = {
                'heater': 'åŠ çƒ­å™¨',
                'cooler': 'å†·å´å™¨',
                'humidifier': 'åŠ æ¹¿å™¨',
                'dehumidifier': 'é™¤æ¹¿å™¨',
                'fan': 'é£æ‰‡',
                'light': 'è¡¥å…‰ç¯',
                'irrigation': 'çŒæº‰ç³»ç»Ÿ'
            };
            return typeNames[type] || type;
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusTexts = {
                'online': 'åœ¨çº¿',
                'offline': 'ç¦»çº¿',
                'error': 'æ•…éšœ'
            };
            return statusTexts[status] || status;
        }

        // å¯åŠ¨è®¾å¤‡
        async function startDevice(deviceId) {
            try {
                showLoading(`æ­£åœ¨å¯åŠ¨è®¾å¤‡ ${deviceId}...`);
                
                // æ¨¡æ‹ŸAPIè°ƒç”¨
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æ›´æ–°è®¾å¤‡çŠ¶æ€
                const device = mockDevices.find(d => d.id === deviceId);
                if (device && device.status === 'online') {
                    device.running = true;
                    device.power = 50; // é»˜è®¤åŠŸç‡
                    renderDevices();
                    showSuccess(`è®¾å¤‡ ${device.name} å¯åŠ¨æˆåŠŸ`);
                }
                
            } catch (error) {
                console.error('å¯åŠ¨è®¾å¤‡å¤±è´¥:', error);
                showError('å¯åŠ¨è®¾å¤‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åœæ­¢è®¾å¤‡
        async function stopDevice(deviceId) {
            try {
                showLoading(`æ­£åœ¨åœæ­¢è®¾å¤‡ ${deviceId}...`);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const device = mockDevices.find(d => d.id === deviceId);
                if (device) {
                    device.running = false;
                    device.power = 0;
                    renderDevices();
                    showSuccess(`è®¾å¤‡ ${device.name} å·²åœæ­¢`);
                }
                
            } catch (error) {
                console.error('åœæ­¢è®¾å¤‡å¤±è´¥:', error);
                showError('åœæ­¢è®¾å¤‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // é‡ç½®è®¾å¤‡
        async function resetDevice(deviceId) {
            try {
                showLoading(`æ­£åœ¨é‡ç½®è®¾å¤‡ ${deviceId}...`);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const device = mockDevices.find(d => d.id === deviceId);
                if (device) {
                    device.running = false;
                    device.power = 0;
                    device.status = 'online';
                    renderDevices();
                    showSuccess(`è®¾å¤‡ ${device.name} é‡ç½®æˆåŠŸ`);
                }
                
            } catch (error) {
                console.error('é‡ç½®è®¾å¤‡å¤±è´¥:', error);
                showError('é‡ç½®è®¾å¤‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // è°ƒèŠ‚åŠŸç‡
        async function adjustPower(deviceId, power) {
            try {
                const device = mockDevices.find(d => d.id === deviceId);
                if (device) {
                    device.power = parseInt(power);
                    // æ›´æ–°æ˜¾ç¤º
                    const powerValue = document.querySelector(`input[onchange*="${deviceId}"]`).parentNode.querySelector('.power-value');
                    powerValue.textContent = power + '%';
                    
                    showSuccess(`è®¾å¤‡ ${device.name} åŠŸç‡è°ƒèŠ‚ä¸º ${power}%`);
                }
                
            } catch (error) {
                console.error('è°ƒèŠ‚åŠŸç‡å¤±è´¥:', error);
                showError('è°ƒèŠ‚åŠŸç‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å¯åŠ¨æ‰€æœ‰è®¾å¤‡
        async function startAllDevices() {
            if (!confirm('ç¡®å®šè¦å¯åŠ¨æ‰€æœ‰åœ¨çº¿è®¾å¤‡å—ï¼Ÿ')) return;
            
            try {
                showLoading('æ­£åœ¨å¯åŠ¨æ‰€æœ‰è®¾å¤‡...');
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                mockDevices.forEach(device => {
                    if (device.status === 'online') {
                        device.running = true;
                        device.power = 50;
                    }
                });
                
                renderDevices();
                showSuccess('æ‰€æœ‰åœ¨çº¿è®¾å¤‡å·²å¯åŠ¨');
                
            } catch (error) {
                console.error('æ‰¹é‡å¯åŠ¨å¤±è´¥:', error);
                showError('æ‰¹é‡å¯åŠ¨å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åœæ­¢æ‰€æœ‰è®¾å¤‡
        async function stopAllDevices() {
            if (!confirm('ç¡®å®šè¦åœæ­¢æ‰€æœ‰è®¾å¤‡å—ï¼Ÿ')) return;
            
            try {
                showLoading('æ­£åœ¨åœæ­¢æ‰€æœ‰è®¾å¤‡...');
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                mockDevices.forEach(device => {
                    device.running = false;
                    device.power = 0;
                });
                
                renderDevices();
                showSuccess('æ‰€æœ‰è®¾å¤‡å·²åœæ­¢');
                
            } catch (error) {
                console.error('æ‰¹é‡åœæ­¢å¤±è´¥:', error);
                showError('æ‰¹é‡åœæ­¢å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆ·æ–°è®¾å¤‡çŠ¶æ€
        async function refreshDevices() {
            try {
                showLoading('æ­£åœ¨åˆ·æ–°è®¾å¤‡çŠ¶æ€...');
                
                // æ¨¡æ‹ŸéšæœºçŠ¶æ€å˜åŒ–
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                mockDevices.forEach(device => {
                    // éšæœºæ¨¡æ‹Ÿä¸€äº›çŠ¶æ€å˜åŒ–
                    if (Math.random() < 0.1) {
                        device.power = Math.floor(Math.random() * 100);
                    }
                });
                
                renderDevices();
                showSuccess('è®¾å¤‡çŠ¶æ€å·²åˆ·æ–°');
                
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                showError('åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // é‡ç½®æ‰€æœ‰è®¾å¤‡
        async function resetAllDevices() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾å¤‡å—ï¼Ÿè¿™å°†åœæ­¢æ‰€æœ‰è®¾å¤‡å¹¶æ¸…é™¤æ•…éšœçŠ¶æ€ã€‚')) return;
            
            try {
                showLoading('æ­£åœ¨é‡ç½®æ‰€æœ‰è®¾å¤‡...');
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                mockDevices.forEach(device => {
                    device.running = false;
                    device.power = 0;
                    device.status = 'online';
                });
                
                renderDevices();
                showSuccess('æ‰€æœ‰è®¾å¤‡å·²é‡ç½®');
                
            } catch (error) {
                console.error('æ‰¹é‡é‡ç½®å¤±è´¥:', error);
                showError('æ‰¹é‡é‡ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å¯¼å‡ºè®¾å¤‡çŠ¶æ€
        function exportDeviceStatus() {
            const data = mockDevices.map(device => ({
                è®¾å¤‡ID: device.id,
                è®¾å¤‡åç§°: device.name,
                è®¾å¤‡ç±»å‹: getDeviceTypeName(device.type),
                çŠ¶æ€: getStatusText(device.status),
                è¿è¡ŒçŠ¶æ€: device.running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢',
                åŠŸç‡: device.power + '%'
            }));
            
            const csv = convertToCSV(data);
            downloadCSV(csv, 'device_status.csv');
            showSuccess('è®¾å¤‡çŠ¶æ€å·²å¯¼å‡º');
        }

        // è½¬æ¢ä¸ºCSVæ ¼å¼
        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header]).join(','))
            ].join('\n');
            return csvContent;
        }

        // ä¸‹è½½CSVæ–‡ä»¶
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ˜¾ç¤ºåŠ è½½æ¶ˆæ¯
        function showLoading(message) {
            showMessage(message, '#17a2b8', '#d1ecf1');
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            showMessage(message, '#155724', '#d4edda');
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            showMessage(message, '#721c24', '#f8d7da');
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, color, background) {
            const div = document.createElement('div');
            div.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${background};
                color: ${color};
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                z-index: 1000;
                max-width: 300px;
            `;
            div.textContent = message;
            document.body.appendChild(div);
            
            setTimeout(() => {
                if (document.body.contains(div)) {
                    document.body.removeChild(div);
                }
            }, 3000);
        }
    </script>
</body>
</html>